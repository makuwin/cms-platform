---
import BaseLayout from "../layouts/BaseLayout.astro";
import SignInCard from "../components/react/SignInCard";
import { getCookieValue } from "../utils/cookies";

export const prerender = false;

const apiBase = import.meta.env.PUBLIC_API_BASE_URL ?? "http://localhost:3000";
const normalizedBase = apiBase.replace(/\/$/, "");
const cookieHeader = Astro.request.headers.get("cookie");
const accessToken = getCookieValue(cookieHeader, "access_token");

let initialUser: {
  id: string;
  name?: string | null;
  email?: string | null;
  role?: string | null;
} | null = null;

if (cookieHeader) {
  try {
    const meResponse = await fetch(`${normalizedBase}/api/auth/me`, {
      headers: {
        Accept: "application/json",
        cookie: cookieHeader,
        ...(accessToken ? { Authorization: `Bearer ${accessToken}` } : {}),
      },
    });
    if (meResponse.ok) {
      const payload = await meResponse.json();
      initialUser = payload?.user ?? null;
    }
  } catch {
    initialUser = null;
  }
}

if (initialUser) {
  return Astro.redirect("/");
}
---

<BaseLayout initialUser={initialUser} title="Sign In | NovaCMS">
  <main
    class="mx-auto flex max-w-5xl flex-col gap-10 px-6 py-14 sm:px-8 lg:gap-12 lg:py-16"
  >
    <section class="flex flex-col gap-4">
      <h1
        class="text-4xl font-semibold text-slate-900 sm:text-5xl sm:leading-tight"
      >
        Welcome back to NovaCMS
      </h1>
      <p class="max-w-2xl text-lg leading-relaxed text-slate-600">
        Manage your content universe, collaborate with teammates, and review
        analytics from a single, unified cockpit.
      </p>
    </section>

    <section
      class="grid gap-10 rounded-3xl bg-white p-10 shadow-2xl ring-1 ring-slate-100 sm:p-12 md:grid-cols-[minmax(0,1.05fr)_minmax(0,0.95fr)]"
    >
      <SignInCard client:load apiBase={apiBase} />

      <aside class="grid gap-6 text-slate-600">
        <img
          src="https://picsum.photos/seed/signin/480/320"
          alt="Abstract monochrome shapes"
          loading="lazy"
          class="w-full rounded-2xl object-cover shadow-lg"
        />
        <div class="space-y-4">
          <h2 class="text-xl font-semibold text-slate-900">Need an account?</h2>
          <p class="text-base leading-relaxed">
            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed luctus
            sed urna id porta. Vestibulum ante ipsum primis in faucibus orci
            luctus et ultrices posuere cubilia curae.
          </p>
          <a
            class="group inline-flex items-center gap-1 text-sm font-semibold text-indigo-600 transition hover:text-indigo-700"
            href="/sign-up"
          >
            Sign up
            <span
              aria-hidden="true"
              class="inline-block translate-x-0 transition group-hover:translate-x-1"
            >
              â†’
            </span>
          </a>
        </div>
      </aside>
    </section>
  </main>
</BaseLayout>
