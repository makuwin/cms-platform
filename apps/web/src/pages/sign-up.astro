---
import BaseLayout from '../layouts/BaseLayout.astro';
import SignUpCard from '../components/react/SignUpCard';
import { getCookieValue } from '../utils/cookies';

export const prerender = false;

const apiBase =
  import.meta.env.PUBLIC_API_BASE_URL ?? 'http://localhost:3000';
const normalizedBase = apiBase.replace(/\/$/, '');
const cookieHeader = Astro.request.headers.get('cookie');
const accessToken = getCookieValue(cookieHeader, 'access_token');

let initialUser:
  | {
      id: string;
      name?: string | null;
      email?: string | null;
      role?: string | null;
    }
  | null = null;

if (cookieHeader) {
  try {
    const meResponse = await fetch(`${normalizedBase}/api/auth/me`, {
      headers: {
        Accept: 'application/json',
        cookie: cookieHeader,
        ...(accessToken ? { Authorization: `Bearer ${accessToken}` } : {}),
      },
    });
    if (meResponse.ok) {
      const payload = await meResponse.json();
      initialUser = payload?.user ?? null;
    }
  } catch {
    initialUser = null;
  }
}

if (initialUser) {
  return Astro.redirect('/');
}
---

<BaseLayout initialUser={initialUser} title="Sign Up | NovaCMS">
  <main class="mx-auto flex max-w-5xl flex-col gap-10 px-6 py-14 sm:px-8 lg:gap-12 lg:py-16">
    <section class="flex flex-col gap-4">
      <h1 class="text-4xl font-semibold text-slate-900 sm:text-5xl sm:leading-tight">
        Create your NovaCMS workspace
      </h1>
      <p class="max-w-2xl text-lg leading-relaxed text-slate-600">
        Join teams shipping content faster. Register below to start building your space in minutes.
      </p>
    </section>

    <section class="grid gap-10 rounded-3xl bg-white p-10 shadow-2xl ring-1 ring-slate-100 sm:p-12 md:grid-cols-[minmax(0,1.05fr)_minmax(0,0.95fr)]">
      <SignUpCard client:load apiBase={apiBase} />

      <aside class="grid gap-6 text-slate-600">
        <img
          class="w-full rounded-2xl object-cover shadow-lg"
          src="https://picsum.photos/seed/signup/480/320"
          alt="Wavy abstract shapes"
          loading="lazy"
        />
        <div class="space-y-4">
          <h2 class="text-xl font-semibold text-slate-900">Why teams choose NovaCMS</h2>
          <ul class="list-disc space-y-2 pl-5 text-slate-600">
            <li>Lorem ipsum dolor sit amet, consectetur adipiscing elit.</li>
            <li>Morbi ac ante in velit vehicula pulvinar.</li>
            <li>Suspendisse potenti. Nullam semper mauris ut augue commodo.</li>
          </ul>
          <p class="text-slate-600">
            Already have an account?
            <a class="font-semibold text-indigo-600 transition hover:text-indigo-700" href="/sign-in">Sign in here</a>
          </p>
        </div>
      </aside>
    </section>
  </main>
</BaseLayout>
